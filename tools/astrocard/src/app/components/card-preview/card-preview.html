<div class="preview-wrapper">
  <!-- The Card (Simulator) -->
  <div
    #cardElement
    id="card-preview"
    class="card"
    [class.aspect-4-5]="data.aspectRatio === '4:5'"
    [class.aspect-9-16]="data.aspectRatio === '9:16'"
    [style.--accent-color]="data.accentColor"
  >
    <!-- Background -->
    <div class="card-background">
      @if (data.backgroundImage) {
        <img [src]="data.backgroundImage" alt="" class="bg-image" />
      }
      <div class="bg-overlay"></div>
    </div>

    <!-- Content -->
    <div class="card-content">
      <!-- Title Section -->
      <section class="card-section title-section">
        <h1 class="card-title font-display">{{ data.title }}</h1>
        <div class="card-meta">
          <span class="meta-item">
            <svg
              class="icon"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
            {{ formattedDate }}
          </span>
          <span class="meta-item">
            <svg
              class="icon"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
              <circle cx="12" cy="10" r="3"></circle>
            </svg>
            {{ data.location }}
          </span>
        </div>
        @if (data.description) {
          <div class="card-description">
            {{
              data.description.length > 200
                ? (data.description | slice: 0 : 200) + '...'
                : data.description
            }}
          </div>
        }
      </section>

      <!-- Integration Section -->
      <section class="card-section integration-section">
        <div class="section-header-row">
          <h2 class="section-header">INTEGRATION</h2>
          <div class="integration-total">
            <span class="integration-label">TOTAL</span>
            <span class="integration-time">{{ totalIntegration }}</span>
          </div>
        </div>

        <div class="filter-rings">
          @for (filter of enabledFilters; track filter.name) {
            <ac-filter-ring
              [name]="filter.name"
              [color]="filter.color"
              [duration]="getFilterDuration(filter)"
              [progress]="getFilterProgress(filter)"
            ></ac-filter-ring>
          }
        </div>
      </section>

      <!-- Equipment & Software Section -->
      <div class="two-column">
        <section class="card-section half">
          <h2 class="section-header">EQUIPMENT</h2>
          <ul class="item-list">
            @for (item of data.equipment; track $index) {
              <li>
                <span class="item-icon">{{ item.icon }}</span>
                <span class="item-text">{{ item.value }}</span>
              </li>
            }
          </ul>
        </section>

        <section class="card-section half">
          <h2 class="section-header">SOFTWARE</h2>
          <ul class="item-list">
            @for (item of data.software; track $index) {
              <li>
                <span class="item-icon">{{ item.icon }}</span>
                <span class="item-text">{{ item.name }}</span>
              </li>
            }
          </ul>
        </section>
      </div>

      <!-- Bottom Row: Bortle Scale + Author side by side -->
      <div class="bottom-row">
        <section class="card-section">
          <ac-bortle-scale
            [value]="data.bortleScale"
            [accentColor]="data.accentColor"
          ></ac-bortle-scale>
        </section>

        <section class="card-section author-section">
          <div class="author-content">
            <svg
              class="author-icon"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect>
              <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path>
              <line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line>
            </svg>
            <span class="author-handle">{{ data.author }}</span>
          </div>
        </section>
      </div>
    </div>
  </div>

  <!-- Controls Below Card -->
  <div class="card-controls">
    <div class="aspect-info">
      <span class="aspect-label">{{ data.aspectRatio }}</span>
      <span class="aspect-dimensions">{{ cardDimensions.width }}×{{ cardDimensions.height }}</span>
    </div>
    <db-neon-button variant="primary" (click)="exportCard($event)">
      ⬇️ Download JPEG
    </db-neon-button>
  </div>
</div>
