<div
  class="card-wrapper"
  #cardWrapper
  [style.transform]="'scale(' + scaleFactor() + ')'"
  [style.height.px]="cardDimensions().height * scaleFactor()"
  [style.margin-bottom.px]="16"
>
  <!-- Interactive Download Overlay -->
  <button
    class="export-overlay-btn"
    (click)="exportCard($event)"
    [class.exporting]="isExporting"
    title="Download Output PNG"
  >
    @if (isExporting) {
      <div class="db-spinner"></div>
      <span class="export-text">PROCESSING</span>
    } @else {
      <svg
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
        class="w-8 h-8"
      >
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
        <polyline points="7 10 12 15 17 10"></polyline>
        <line x1="12" y1="15" x2="12" y2="3"></line>
      </svg>
    }
  </button>

  <div
    class="card"
    #cardElement
    [style.width.px]="cardDimensions().width"
    [style.height.px]="cardDimensions().height"
    [style.background-image]="
      cardData().backgroundImage ? 'url(' + cardData().backgroundImage + ')' : 'none'
    "
  >
    <!-- Solid black background if no image -->
    <div class="card__background" *ngIf="!cardData().backgroundImage"></div>

    <!-- Gradient overlays for text readability -->
    <div class="card__overlay card__overlay--bottom"></div>

    <div class="card__content" [style.opacity]="cardData().cardOpacity">
      <!-- Header -->
      <div class="card__header">
        <h1 class="card__title">{{ cardData().title }}</h1>
      </div>

      <!-- Main Meta Grid -->
      <div class="card__meta db-glass-panel">
        <div class="meta-column meta-right">
          <ac-bortle-scale [scale]="cardData().bortleScale"></ac-bortle-scale>
          <div class="meta-row meta-date-location">
            @if (cardData().location) {
              <div class="meta-item location">
                <span class="icon">üìç</span>
                <span class="value">{{ cardData().location }}</span>
              </div>
            }
            @if (cardData().date) {
              <div class="meta-item date">
                <span class="icon">üìÖ</span>
                <span class="value">{{ formattedDate() }}</span>
              </div>
            }
          </div>
        </div>
      </div>

      <!-- Filter Stats -->
      <div class="card__filters" *ngIf="enabledFilters().length > 0">
        <div class="filters-header">
          <span class="integration-label">TOTAL INTEGRATION</span>
          <span class="integration-value db-neon-text">{{ totalIntegration() }}</span>
        </div>
        <div class="filters-grid" [class.compact]="enabledFilters().length > 4">
          @for (filter of enabledFilters(); track filter.name) {
            <div class="filter-item">
              <ac-filter-ring
                [color]="filter.color"
                [progress]="getFilterProgress(filter)"
                [filterName]="filter.name"
              ></ac-filter-ring>
              <div class="filter-details">
                <span class="filter-name" [style.color]="filter.color">{{ filter.name }}</span>
                <span class="filter-time">{{ getFilterDuration(filter) }}</span>
              </div>
            </div>
          }
        </div>
      </div>

      <!-- Equipment & Software Grid -->
      <div class="details-grid">
        <!-- Equipment -->
        <div class="details-section">
          <h3 class="section-title">Equipment</h3>
          <div class="items-list">
            @for (item of cardData().equipment; track item.label) {
              @if (item.value) {
                <div class="db-meta-item">
                  <span class="db-meta-label">
                    <span class="db-meta-icon">{{ item.icon }}</span>
                    {{ item.label }}
                  </span>
                  <span class="db-meta-value">{{ item.value }}</span>
                </div>
              }
            }
          </div>
        </div>

        <!-- Software -->
        <div class="details-section">
          <h3 class="section-title">Software</h3>
          <div class="items-list">
            @for (item of cardData().software; track item.label) {
              @if (item.name) {
                <div class="db-meta-item">
                  <span class="db-meta-label">
                    <span class="db-meta-icon">{{ item.icon }}</span>
                    {{ item.label }}
                  </span>
                  <span class="db-meta-value">{{ item.name }}</span>
                </div>
              }
            }
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
